---
title: "Tidy Tuesday 11/24/2020 Washington Trails"
author: "greg dubrow"
date: "11/24/2020"
output: md_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "images/",
  out.width = "100%") 
```

```{r pkg load, message=FALSE, ECHO = FALSE}
# readin in data, create df for plots
library(tidytuesdayR) # to load tidytuesday data
library(tidyverse) # to do tidyverse things
library(tidylog) # to get a log of what's happening to the data
library(patchwork) # stitch plots together
library(reactable) # pretty tables
library(htmltools) # help with pretty tables
library(RColorBrewer) # colors!
library(scales) # format chart output
```

### First let's read in the file using the tidytuesdayR package. We'll also look at the raw data
```{r echo = FALSE, message=FALSE}
tt_watrail <- tt_load("2020-11-24")

glimpse(tt_watrail$hike_data)
```

### There are a few things we want to do with the data for the working dataframe: 
  * create columns for miles, direction, type from length
  * create specific location columns frolm location
  * change rating, gain and highpoint to numeric
  * create a rating group
  * separate out features and make the resulting df long. we'll use distinct when we only need 1 obs per trail

```{r echo = FALSE}
tt_watraildf <- tt_watrail$hike_data %>%
  mutate(length_miles = parse_number(length)) %>%
  mutate(across(gain:rating, as.numeric)) %>%
  mutate(rating_grp = case_when(rating == 0 ~ "0",
                                rating >0 & rating < 2 ~ "1",
                                rating >=2 & rating < 3 ~ "2",
                                rating >=3 & rating < 4 ~ "3",
                                rating >=4 & rating < 5 ~ "4",
                                rating == 5 ~ "5")) %>%
  mutate(trail_type = case_when(grepl("roundtrip", length) ~ "Round trip",
                          grepl("one-way", length) ~ "One Way",
                          grepl("of trails", length) ~ "Trails")) %>% 
  mutate(location_split = location) %>%
  separate(location_split, c("location_region","location_specific"), sep = ' -- ') %>%
  unnest(cols = c(features)) %>% 
  mutate(feature_init = case_when(features == "Dogs allowed on leash" ~ "DA",
                                  features == "Dogs not allowed" ~ "DN",
                                  features == "Wildlife" ~ "Wl",
                                  features == "Good for kids" ~ "GK",
                                  features == "Lakes" ~ "Lk",
                                  features == "Fall foliage" ~ "FF",
                                  features == "Ridges/passes" ~ "RP",
                                  features == "Established campsites" ~ "EC",
                                  features == "Mountain views" ~ "MV",
                                  features == "Old growth" ~ "OG",
                                  features == "Waterfalls" ~ "Wf",
                                  features == "Wildflowers/Meadows" ~ "WM",
                                  features == "Rivers" ~ "Ri",
                                  features == "Coast" ~ "Co",
                                  features == "Summits" ~ "Su")) %>%
  mutate(feature_type = if_else(feature_init %in% c("DA","DN","GK"), "Companion", "Feature")) %>%
  select(name, location_region, location_specific, trail_type, length_miles, 
         gain, highpoint, rating, rating_grp, features, feature_init, feature_type, description, location, length)

```

### To get a sense of what the data look like, I'll run some historgrams and scatterplots to see how things cluster, if there are outliers or anything else especially noticable.
Using log10 for the length scale to even out the spread. [Patchwork](https://patchwork.data-imaginist.com/) stitches the plots together in a neat panel.
```{r fig.width=7.5, fig.height=4.0, dpi = 300, echo = FALSE, warning=FALSE, message = FALSE, error= FALSE }
hist_length <-
tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(length_miles)) +
  geom_histogram(alpha = 0.8) +
  scale_x_log10() +
  labs(x = "Length (miles), log10")

hist_gain <-
  tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(gain)) +
  geom_histogram(alpha = 0.8) +
  scale_x_log10()

hist_high <-
  tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(highpoint)) +
  geom_histogram(alpha = 0.8) 

hist_rate <-
  tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(rating)) +
  geom_histogram(alpha = 0.8) 

(hist_length | hist_gain) /
  (hist_high | hist_rate)
```
For the scatterplots, I plotted length by gain, faceting by ratings groups and then by region. We do have to be careful with ratings, as they are user-generated and some trails have very few votes. Log10 used again for length.
```{r fig.width=7.5, fig.height=4.0, dpi = 300, echo = FALSE, warning=FALSE, message = FALSE, error= FALSE }

tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(length_miles, gain)) +
  geom_point() +
  geom_smooth() +
  scale_x_log10() +
  labs(x = "Length (miles) log10", y = "Total Gain",
       title = "Length v Gain, by Rating Group") +
  facet_wrap(vars(rating_grp))

tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  ggplot(aes(length_miles, gain)) +
  geom_point() +
  geom_smooth() +
  scale_x_log10() +
  labs(x = "Length (miles) log 10", y = "Total Gain",
       title = "Length v Gain, by Region") +
  facet_wrap(vars(location_region))

```

The outliers in terms of gain & length clustered in a few regions, so I wanted to see which they were. Not a surprise they clustered in the Cascades & Rainier.
```{r echo = FALSE, warning=FALSE, message = FALSE, error= FALSE}
tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  filter(gain > 15000) %>%
  filter(length_miles > 90) %>%
  select(location_region, name, length_miles, gain) %>%
  arrange(name) 

```

### Now that we see how the length, gain, highpoint & ratings spread out, I want build a table to see the averages by region. 

I've been wanting to take a deeper dive on [gt](https://gt.rstudio.com/) & [reactable](https://glin.github.io/reactable/). So inspired by [Thomas Mock's reacable primer](https://themockup.blog/posts/2020-05-13-reactable-tables-the-rest-of-the-owl), a basic table with heatmap-like formatting for some columns. Since I'm mostly recreating Thomas' table (but with different data) I won't comment to much code. See his explainer for details.
```{r fig.width=7.5, fig.height=4.0, dpi = 300, echo = FALSE, warning=FALSE, message = FALSE, error= FALSE }

## create color palates for conidtional cell colors

make_color_pal <- function(colors, bias = 1) {
  get_color <- colorRamp(colors, bias = bias)
  function(x) rgb(get_color(x), maxColorValue = 255)
}
good_color <- make_color_pal(c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"), bias = 2)

# data frame with averages by region
byregion <-  tt_watraildf %>%
  distinct(name, .keep_all = TRUE) %>%
  group_by(location_region) %>%
  summarise(n_region = n(),
    avglength = mean(length_miles),
    avgrating = mean(rating),
    avggain = mean(gain),
    avghigh = mean(highpoint),
    minhigh = min(highpoint),
    maxhigh = max(highpoint)) %>%
  mutate_at(vars(avglength:avgrating), round, 2) %>%
  mutate_at(vars(avggain:avghigh), round, 0) 

# build the table and store as an object 
tbl_region <-
byregion %>%
  reactable(pagination = FALSE, compact = TRUE, 
            borderless = FALSE, striped = TRUE,
            columns = list(
              location_region = colDef(name = "Region"),
              n_region = colDef(name = "N"),
              avglength = colDef(
                name = "Avg Length (miles) ", align = "center",
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$avglength)) /
                    (max(byregion$avglength) - min(byregion$avglength))
                  color <- good_color(normalized)
                  list(background = color)
                }), 
              avgrating = colDef(
                name = "Avg Rating", align = "center",
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$avgrating)) /
                    (max(byregion$avgrating) - min(byregion$avgrating))
                  color <- good_color(normalized)
                  list(background = color)
                }),
              avggain = colDef(
                name = "Avg Gain", align = "center",
                format = colFormat(separators = TRUE),
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$avggain)) /
                    (max(byregion$avggain) - min(byregion$avggain))
                  color <- good_color(normalized)
                  list(background = color)
                }),
              avghigh = colDef(
                name = "Avg High Point", align = "center",
                format = colFormat(separators = TRUE),
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$avghigh)) /
                    (max(byregion$avghigh) - min(byregion$avghigh))
                  color <- good_color(normalized)
                  list(background = color)
                }),
              minhigh = colDef(
                name = "Min High Point", align = "center",
                format = colFormat(separators = TRUE),
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$minhigh)) /
                    (max(byregion$minhigh) - min(byregion$minhigh))
                  color <- good_color(normalized)
                  list(background = color)
                }),
              maxhigh = colDef(
                name = "Max High Point", align = "center",
                format = colFormat(separators = TRUE),
                style = function(value) {
                  value
                  normalized <- (value - min(byregion$maxhigh)) /
                    (max(byregion$maxhigh) - min(byregion$maxhigh))
                  color <- good_color(normalized)
                  list(background = color)
                })))

# add title via CSS
div(class = "region",
    div(class = "example-header",
        div(class = "title", 
            "Averages by Trail Region"),
        tbl_region
    )
)
```
